<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Check-in Form View -->
    <record id="view_kids_child_checkin_form" model="ir.ui.view">
        <field name="name">kids.child.checkin.form</field>
        <field name="model">kids.child.checkin</field>
        <field name="arch" type="xml">
            <form string="Child Check-in">
                <header>
                    <button name="action_send_otp" type="object" string="Send OTP" 
                            class="btn-primary" invisible="state != 'pending_otp'"/>
                    <button name="action_checkout" type="object" string="Check Out" 
                            class="btn-success" invisible="state != 'checked_in'"/>
                    <button name="action_confirm_payment" type="object" string="Confirm Payment" 
                            class="btn-warning" invisible="state != 'pending_payment'"/>
                    <field name="state" widget="statusbar" statusbar_visible="pending_otp,checked_in,pending_payment,pending_checkout_otp,checked_out"/>
                </header>
                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <button name="action_view_extra_invoice" type="object" 
                                class="oe_stat_button" icon="fa-file-text-o"
                                invisible="not extra_invoice_id">
                            <field name="extra_charges" widget="monetary"/>
                            <div>Extra Invoice</div>
                        </button>
                    </div>
                    
                    <div class="oe_title">
                        <h1>
                            <field name="name" readonly="1"/>
                        </h1>
                    </div>
                    
                    <group>
                        <group>
                            <field name="child_id" readonly="1"/>
                            <field name="room_id" domain="[('active', '=', True)]" 
                                   options="{'no_create': True}"/>
                            <field name="subscription_id" readonly="1"/>
                            <field name="checkin_time" readonly="1"/>
                            <field name="checkout_time" readonly="1"/>
                        </group>
                        <group>
                            <field name="duration_minutes" widget="integer"/>
                            <field name="currency_id" invisible="1"/>
                        </group>
                    </group>
                    
                    <notebook>
                        <page string="Payment Confirmation" invisible="state != 'pending_payment'">
                            <div class="alert alert-warning" role="alert">
                                <h4><i class="fa fa-credit-card"/> Payment Required</h4>
                                <p><strong>Extra charges need to be confirmed before checkout:</strong></p>
                                <div class="row">
                                    <div class="col-md-6">
                                        <table class="table table-sm">
                                            <tr>
                                                <td><strong>Child:</strong></td>
                                                <td><field name="child_id" readonly="1"/></td>
                                            </tr>
                                            <tr>
                                                <td><strong>Total Duration:</strong></td>
                                                <td><field name="duration_minutes"/> minutes</td>
                                            </tr>
                                            <tr>
                                                <td><strong>Free Time Used:</strong></td>
                                                <td><field name="free_minutes_used"/> minutes</td>
                                            </tr>
                                            <tr class="table-warning">
                                                <td><strong>Extra Time:</strong></td>
                                                <td><field name="extra_minutes"/> minutes</td>
                                            </tr>
                                            <tr class="table-danger">
                                                <td><strong>Extra Charges:</strong></td>
                                                <td><field name="extra_charges" widget="monetary"/></td>
                                            </tr>
                                        </table>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="alert alert-info">
                                            <h5>Payment Instructions:</h5>
                                            <p>1. Confirm the extra charges amount</p>
                                            <p>2. Click "Confirm Payment" to proceed</p>
                                            <p>3. OTP will be sent for final checkout</p>
                                            <p>4. Invoice will be generated for parent</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </page>
                        
                        <page string="OTP Verification" invisible="state in ['checked_out', 'cancelled', 'pending_payment']">
                            <!-- Check-in OTP Section -->
                            <div invisible="state not in ['pending_otp', 'checked_in', 'pending_checkout_otp']">
                                <h4>Check-in OTP</h4>
                                <group>
                                    <field name="otp_code" readonly="1" invisible="not otp_code"/>
                                    <field name="otp_sent_time" readonly="1" invisible="not otp_sent_time"/>
                                    <field name="otp_verified_time" readonly="1" invisible="not otp_verified_time"/>
                                </group>
                                
                                <!-- Check-in OTP Input Section -->
                                <div invisible="state != 'pending_otp'">
                                    <div class="alert alert-info" role="alert">
                                        <strong>Check-in OTP Required:</strong> Please ask parent to provide the OTP sent to their email/mobile and enter it below.
                                    </div>
                                    <group>
                                        <field name="entered_otp" placeholder="Enter check-in OTP from parent" invisible="otp_verified" force_save="1"/>
                                    </group>
                                    <div class="oe_button_box">
                                        <button name="verify_otp_action" type="object" string="Verify Check-in OTP" 
                                                class="btn-primary" invisible="otp_verified or not entered_otp"/>
                                        <button name="action_resend_otp" type="object" string="Resend Check-in OTP" 
                                                class="btn-secondary" invisible="otp_verified"/>
                                    </div>
                                </div>
                                
                                <div invisible="state not in ['checked_in', 'pending_checkout_otp']">
                                    <div class="alert alert-success" role="alert">
                                        <strong>âœ“ Check-in OTP Verified!</strong> Child is checked in.
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Check-out OTP Section -->
                            <div invisible="state not in ['pending_checkout_otp']">
                                <hr/>
                                <h4>Check-out OTP</h4>
                                <group>
                                    <field name="checkout_otp_code" readonly="1" invisible="not checkout_otp_code"/>
                                    <field name="checkout_otp_sent_time" readonly="1" invisible="not checkout_otp_sent_time"/>
                                    <field name="checkout_otp_verified_time" readonly="1" invisible="not checkout_otp_verified_time"/>
                                </group>
                                
                                <!-- Check-out OTP Input Section -->
                                <div invisible="state != 'pending_checkout_otp'">
                                    <div class="alert alert-warning" role="alert">
                                        <strong>Check-out OTP Required:</strong> Please ask parent to provide the checkout OTP sent to their email/mobile and enter it below.
                                    </div>
                                    <group>
                                        <field name="entered_checkout_otp" placeholder="Enter check-out OTP from parent" invisible="checkout_otp_verified" force_save="1"/>
                                    </group>
                                    <div class="oe_button_box">
                                        <button name="verify_checkout_otp_action" type="object" string="Verify Check-out OTP" 
                                                class="btn-primary" invisible="checkout_otp_verified or not entered_checkout_otp"/>
                                        <button name="action_resend_checkout_otp" type="object" string="Resend Check-out OTP" 
                                                class="btn-secondary" invisible="checkout_otp_verified"/>
                                    </div>
                                </div>
                            </div>
                        </page>
                        
                        <page string="Time &amp; Charges">
                            <group>
                                <group>
                                    <field name="free_minutes_used"/>
                                    <field name="extra_minutes"/>
                                </group>
                                <group>
                                    <field name="extra_charges" widget="monetary"/>
                                    <field name="extra_invoice_id" readonly="1" invisible="not extra_invoice_id"/>
                                </group>
                            </group>
                        </page>
                    </notebook>
                </sheet>
                <chatter/>
            </form>
        </field>
    </record>

    <!-- Check-in List View -->
    <record id="view_kids_child_checkin_list" model="ir.ui.view">
        <field name="name">kids.child.checkin.list</field>
        <field name="model">kids.child.checkin</field>
        <field name="arch" type="xml">
            <list string="Check-ins" decoration-success="state=='checked_out'" 
                  decoration-info="state=='checked_in'" decoration-muted="state=='cancelled'">
                <field name="name"/>
                <field name="child_id"/>
                <field name="checkin_time"/>
                <field name="checkout_time"/>
                <field name="duration_minutes"/>
                <field name="extra_minutes"/>
                <field name="extra_charges" widget="monetary"/>
                <field name="state" widget="badge" 
                       decoration-success="state=='checked_out'"
                       decoration-info="state=='checked_in'"
                       decoration-warning="state=='pending_otp'"
                       decoration-danger="state=='cancelled'"/>
            </list>
        </field>
    </record>

    <!-- Check-in Search View -->
    <record id="view_kids_child_checkin_search" model="ir.ui.view">
        <field name="name">kids.child.checkin.search</field>
        <field name="model">kids.child.checkin</field>
        <field name="arch" type="xml">
            <search string="Search Check-ins">
                <field name="name"/>
                <field name="child_id"/>
                <field name="checkin_time"/>
                <field name="state"/>
                <filter string="Active Check-ins" name="active_checkins" 
                        domain="[('state', '=', 'checked_in')]"/>
                <filter string="Today" name="today" 
                        domain="[('checkin_time', '>=', context_today().strftime('%Y-%m-%d 00:00:00')),
                                ('checkin_time', '&lt;', (context_today() + datetime.timedelta(days=1)).strftime('%Y-%m-%d 00:00:00'))]"/>
                <filter string="This Week" name="this_week" 
                        domain="[('checkin_time', '>=', (context_today() - datetime.timedelta(days=context_today().weekday())).strftime('%Y-%m-%d 00:00:00'))]"/>
                <group expand="0" string="Group By">
                    <filter string="Child" name="group_child" context="{'group_by': 'child_id'}"/>
                    <filter string="Status" name="group_state" context="{'group_by': 'state'}"/>
                    <filter string="Check-in Date" name="group_checkin_date" context="{'group_by': 'checkin_time:day'}"/>
                </group>
            </search>
        </field>
    </record>

    <!-- Real-time Dashboard Kanban View -->
    <record id="view_kids_checkin_dashboard_list" model="ir.ui.view">
        <field name="name">kids.checkin.dashboard.list</field>
        <field name="model">kids.child.checkin</field>
        <field name="arch" type="xml">
            <list string="Live Kids Dashboard" create="false" edit="false">
                <field name="child_id" string="Child Name"/>
                <field name="checkin_time" string="Check-in Time"/>
                <field name="state" string="Status"/>
                <field name="live_timer" string="Time" widget="char" 
                       decoration-success="extra_minutes == 0" 
                       decoration-warning="extra_minutes > 0"
                       options="{'js_class': 'live_timer_widget'}"/>
                <!-- Hidden field for JavaScript to access package time configuration -->
                <field name="allowed_minutes" string="Allowed Minutes"/>
                <button name="action_dashboard_checkout" type="object" string="Check Out" 
                        class="btn-success" icon="fa-sign-out" 
                        invisible="state != 'checked_in'"/>
            </list>
        </field>
    </record>

    <!-- Check-in Wizard for Quick Check-in -->
    <record id="view_kids_checkin_wizard_form" model="ir.ui.view">
        <field name="name">kids.checkin.wizard.form</field>
        <field name="model">kids.checkin.wizard</field>
        <field name="arch" type="xml">
            <form string="Quick Check-in/Check-out">
                <sheet>
                    <div class="oe_title">
                        <h1>Quick Check-in/Check-out</h1>
                        <h2 invisible="current_state == 'new'">
                            <field name="current_state" readonly="1" widget="badge" 
                                   decoration-info="current_state == 'pending_otp'"
                                   decoration-success="current_state == 'checked_in'"
                                   decoration-warning="current_state == 'pending_checkout_otp'"
                                   decoration-muted="current_state == 'checked_out'"/>
                        </h2>
                    </div>
                    
                    <group string="Child Information">
                        <field name="child_id" placeholder="Select child to check in"/>
                        <field name="room_id" placeholder="Select room (optional)" 
                               domain="[('active', '=', True)]" 
                               options="{'no_create': True}"/>
                        <field name="barcode_scan" placeholder="Scan child's barcode"/>
                    </group>
                    
                    <group string="Subscription Validation" invisible="not child_id or current_state != 'new'">
                        <field name="subscription_id" readonly="1"/>
                        <field name="remaining_visits" readonly="1"/>
                        <field name="validation_message" readonly="1" invisible="not validation_message"/>
                    </group>
                    
                    <!-- Check-in OTP Section -->
                    <group string="Check-in OTP Verification" invisible="current_state != 'pending_otp'">
                        <div class="alert alert-info" role="alert">
                            <strong>Check-in OTP Required:</strong> Please ask parent to provide the OTP sent to their email/mobile and enter it below.
                        </div>
                        <field name="sent_otp_code" string="Sent OTP Code (for testing)" readonly="1" invisible="not sent_otp_code"/>
                        <field name="otp_code" placeholder="Enter check-in OTP from parent" required="current_state == 'pending_otp'"/>
                    </group>
                    
                    <!-- Checked In Status -->
                    <group string="Status" invisible="current_state != 'checked_in'">
                        <div class="alert alert-success" role="alert">
                            <strong>âœ“ Child is Checked In!</strong> Ready for check-out when needed.
                        </div>
                    </group>
                    
                    <!-- Check-out OTP Section -->
                    <group string="Check-out OTP Verification" invisible="current_state != 'pending_checkout_otp'">
                        <div class="alert alert-warning" role="alert">
                            <strong>Check-out OTP Required:</strong> Please ask parent to provide the checkout OTP sent to their email/mobile and enter it below.
                        </div>
                        <field name="sent_checkout_otp_code" string="Sent Checkout OTP Code (for testing)" readonly="1" invisible="not sent_checkout_otp_code"/>
                        <field name="checkout_otp_code" placeholder="Enter check-out OTP from parent" required="current_state == 'pending_checkout_otp'"/>
                    </group>
                    
                    <!-- Checked Out Status -->
                    <group string="Status" invisible="current_state != 'checked_out'">
                        <div class="alert alert-success" role="alert">
                            <strong>âœ“ Check-out Complete!</strong> Child has been successfully checked out.
                        </div>
                    </group>
                </sheet>
                
                <footer>
                    <!-- Check-in Flow Buttons -->
                    <button name="action_direct_checkin" type="object" string="Direct Check-in" 
                            class="btn-primary" invisible="current_state != 'new'"/>
                    
                    <button name="action_send_otp" type="object" string="Send Check-in OTP" 
                            class="btn-secondary" invisible="current_state != 'new'"/>
                    
                    <button name="action_verify_checkin" type="object" string="Verify Check-in OTP" 
                            class="btn-success" invisible="current_state != 'pending_otp' or not otp_code"/>
                    
                    <button name="action_resend_checkin_otp" type="object" string="Resend Check-in OTP" 
                            class="btn-secondary" invisible="current_state != 'pending_otp'"/>
                    
                    <!-- Check-out Flow Buttons -->
                    <button name="action_send_checkout_otp" type="object" string="Send Check-out OTP" 
                            class="btn-warning" invisible="current_state != 'checked_in'"/>
                    
                    <button name="action_verify_checkout" type="object" string="Verify Check-out OTP" 
                            class="btn-success" invisible="current_state != 'pending_checkout_otp' or not checkout_otp_code"/>
                    
                    <button name="action_resend_checkout_otp" type="object" string="Resend Check-out OTP" 
                            class="btn-secondary" invisible="current_state != 'pending_checkout_otp'"/>
                    
                    <!-- Common Buttons -->
                    <button string="Close" class="btn-secondary" special="cancel"/>
                </footer>
            </form>
        </field>
    </record>

    <!-- Actions -->
    <record id="action_kids_child_checkin" model="ir.actions.act_window">
        <field name="name">Check-ins</field>
        <field name="res_model">kids.child.checkin</field>
        <field name="view_mode">list,form</field>
        <field name="context">{'search_default_today': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No check-ins found!
            </p>
            <p>
                Start by checking in children using the Quick Check-in wizard.
            </p>
        </field>
    </record>

    <record id="action_kids_checkin_dashboard" model="ir.actions.act_window">
        <field name="name">Live Kids Dashboard</field>
        <field name="res_model">kids.child.checkin</field>
        <field name="view_mode">list</field>
        <field name="view_id" ref="view_kids_checkin_dashboard_list"/>
        <field name="domain">[('state', '=', 'checked_in')]</field>
        <field name="context">{'create': False, 'search_default_today': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No kids are currently checked in!
            </p>
            <p>
                Use the Quick Check-in wizard to start monitoring kids in real-time.
            </p>
        </field>
    </record>

    <record id="action_kids_checkin_wizard" model="ir.actions.act_window">
        <field name="name">Quick Check-in/Check-out</field>
        <field name="res_model">kids.checkin.wizard</field>
        <field name="view_mode">form</field>
        <field name="target">new</field>
    </record>


</odoo>
